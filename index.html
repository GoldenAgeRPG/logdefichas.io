<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciador de Logs - Golden Age RPG</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Rajdhani:wght@600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <style>
    /* --- CSS DA INTERFACE --- */
    :root {
      --ui-bg: #121212; --ui-panel: #1e1e24; --ui-border: #333;
      --ui-accent: #a855f7; --ui-text: #f0f0f0; --ui-dim: #888;
      --ui-success: #20c56d; --ui-danger: #c52020;
    }

    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Roboto', sans-serif; background-color: var(--ui-bg); color: var(--ui-text); }
    
    .layout-grid { display: grid; grid-template-columns: 450px 1fr; height: 100%; width: 100%; }
    
    /* Editor */
    .editor-pane { background: var(--ui-panel); border-right: 1px solid var(--ui-border); display: flex; flex-direction: column; height: 100%; min-height: 0; z-index: 10; box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
    
    .editor-header { padding: 20px; border-bottom: 1px solid var(--ui-border); background: #16161b; flex-shrink: 0; }
    .editor-header h1 { margin: 0; font-size: 1.4em; color: var(--ui-accent); text-transform: uppercase; font-family: 'Rajdhani', sans-serif; }
    
    .editor-scroll-area { flex: 1 1 auto; overflow-y: auto; padding: 20px; }
    .editor-content-wrapper { display: flex; flex-direction: column; gap: 20px; padding-bottom: 100px; }

    /* Inputs */
    label { font-size: 0.75em; font-weight: 700; color: var(--ui-dim); text-transform: uppercase; margin-bottom: 5px; display: block; }
    input, textarea, select { background: #0a0a0d; border: 1px solid var(--ui-border); color: #fff; padding: 10px; border-radius: 4px; font-family: inherit; font-size: 0.9em; width: 100%; box-sizing: border-box; }
    input:focus, textarea:focus { outline: none; border-color: var(--ui-accent); }
    
    .row { display: flex; gap: 10px; } .col { flex: 1; }

    /* Cards Dinâmicos */
    .dynamic-list { display: flex; flex-direction: column; gap: 10px; }
    .dynamic-item { background: #25252e; border: 1px solid var(--ui-border); padding: 10px; border-radius: 4px; position: relative; }
    .btn-remove { position: absolute; top: 5px; right: 5px; cursor: pointer; color: var(--ui-danger); font-size: 0.8em; font-weight: bold; }

    .stat-row { display: grid; grid-template-columns: 1fr 60px 60px; gap: 5px; align-items: center; }
    
    /* Botões */
    .btn { padding: 10px; border: none; border-radius: 4px; font-weight: 700; cursor: pointer; width: 100%; transition: filter 0.2s; font-family: 'Rajdhani', sans-serif; text-transform: uppercase; letter-spacing: 1px; }
    .btn:hover { filter: brightness(1.1); }
    .btn-primary { background: var(--ui-accent); color: #fff; }
    .btn-secondary { background: #333; color: #ddd; }
    .btn-success { background: var(--ui-success); color: #000; }
    .btn-danger { background: var(--ui-danger); color: #fff; }

    /* Preview */
    .preview-pane { background: #121212; overflow-y: auto; height: 100%; display: flex; justify-content: center; padding: 40px; box-sizing: border-box; }
    #preview-box { width: 100%; max-width: 800px; }

    /* --- NOVOS MODAIS E TOASTS --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 1000; display: none;
        justify-content: center; align-items: center; backdrop-filter: blur(3px);
    }
    .modal-box {
        background: var(--ui-panel); border: 1px solid var(--ui-border);
        padding: 25px; border-radius: 8px; width: 90%; max-width: 500px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: popIn 0.2s ease;
    }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-title { font-family: 'Rajdhani', sans-serif; font-size: 1.5em; color: var(--ui-accent); margin-bottom: 15px; text-transform: uppercase; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

    .toast {
        position: fixed; top: 20px; right: 20px; background: var(--ui-success); color: #000;
        padding: 12px 25px; border-radius: 4px; font-weight: bold; z-index: 2000;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); transform: translateX(150%); transition: transform 0.3s ease;
    }
    .toast.show { transform: translateX(0); }

    @media (max-width: 900px) {
      .layout-grid { grid-template-columns: 1fr; display: block; overflow: auto; height: auto; }
      .editor-pane { height: auto; min-width: 100%; border-right: none; }
      .preview-pane { min-height: 100vh; }
    }
  </style>
</head>
<body>

  <div id="toast" class="toast">Código Copiado!</div>

  <div id="confirm-modal" class="modal-overlay">
      <div class="modal-box">
          <div class="modal-title">Confirmar Ação</div>
          <p id="confirm-msg">Tem certeza?</p>
          <div class="modal-actions">
              <button class="btn btn-secondary" style="width:auto;" onclick="closeModal('confirm-modal')">Cancelar</button>
              <button id="confirm-yes-btn" class="btn btn-danger" style="width:auto;">Confirmar</button>
          </div>
      </div>
  </div>

  <div id="import-modal" class="modal-overlay">
      <div class="modal-box" style="max-width: 600px;">
          <div class="modal-title">Importar Log Existente</div>
          <p style="font-size:0.9em; color:#ccc; margin-bottom:10px;">Cole o código HTML completo do log que deseja editar.</p>
          <textarea id="import-area" rows="10" placeholder="<link ... <div class='log-container'>..."></textarea>
          <div class="modal-actions">
              <button class="btn btn-secondary" style="width:auto;" onclick="closeModal('import-modal')">Cancelar</button>
              <button class="btn btn-primary" style="width:auto;" onclick="processImport()">Carregar Dados</button>
          </div>
      </div>
  </div>

  <div class="layout-grid">
    <div class="editor-pane">
      <div class="editor-header">
        <h1>Registro de Modificação</h1>
        <div class="row" style="margin-top:10px;">
          <button class="btn btn-primary" style="padding:5px;" onclick="openImportModal()">Importar Log</button>
          <button class="btn btn-secondary" style="padding:5px;" onclick="confirmReset()">Novo Log</button>
        </div>
      </div>
      
      <div class="editor-scroll-area">
        <div class="editor-content-wrapper">
          
          <div style="background:#15151a; padding:15px; border-radius:6px; border:1px solid #333;">
            <label>Informações do Registro</label>
            <input type="text" id="inp-char" placeholder="Nome do Personagem" oninput="upd()">
            <input type="text" id="inp-char-link" placeholder="Link da Ficha" style="margin-top:5px;" oninput="upd()">
            
            <div class="row" style="margin-top:5px;">
                <div class="col"><input type="text" id="inp-date" placeholder="DD/MM/AAAA" oninput="upd()"></div>
            </div>
            
            <label style="margin-top:10px;">Fonte da Mudança (Principal)</label>
            <input type="text" id="inp-source" placeholder="Ex: Relatório Missão 01" oninput="upd()">
            <input type="text" id="inp-source-link" placeholder="Link do Tópico" style="margin-top:5px;" oninput="upd()">
          </div>

          <div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
               <label>Links Comprobatórios Adicionais</label>
               <button class="btn btn-secondary" style="width:auto; padding:2px 8px; font-size:0.7em;" onclick="addLink()">+ Link</button>
            </div>
            <div id="links-list" class="dynamic-list" style="margin-top:5px;"></div>
          </div>

          <div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
               <label>Alterações de Status (Grid)</label>
               <button class="btn btn-secondary" style="width:auto; padding:2px 8px; font-size:0.7em;" onclick="addStat()">+ Item</button>
            </div>
            <div id="stats-list" class="dynamic-list"></div>
          </div>

          <div>
             <label>Conteúdo Adicional</label>
             <div class="row" style="margin-bottom:10px;">
                 <button class="btn btn-success" onclick="addBlock('add')">+ Adicionado</button>
                 <button class="btn btn-danger" onclick="addBlock('remove')">- Removido</button>
             </div>
             <div id="blocks-list" class="dynamic-list"></div>
          </div>

          <div>
            <label>Código Final</label>
            <textarea id="output-code" readonly style="height:100px; border-color:var(--ui-accent); color:var(--ui-accent); font-family:monospace;"></textarea>
            <button class="btn btn-primary" style="margin-top:5px;" onclick="copyCode()">Copiar HTML</button>
          </div>

        </div>
      </div>
    </div>

    <div class="preview-pane">
      <link href="https://gaaaaaaaaabs.github.io/goldenagerepositor.io/log-ficha.css" rel="stylesheet" type="text/css">
      <div id="preview-box"></div>
    </div>
  </div>

<script>
  let state = {
    char: "", charLink: "", date: new Date().toLocaleDateString('pt-BR'),
    source: "", sourceLink: "",
    links: [], // { title, url }
    stats: [], // {name, oldVal, newVal}
    blocks: [] // {type, title, content}
  };

  if(state.stats.length === 0) addStat(false);

  function upd() {
    state.char = document.getElementById('inp-char').value;
    state.charLink = document.getElementById('inp-char-link').value;
    state.date = document.getElementById('inp-date').value;
    state.source = document.getElementById('inp-source').value;
    state.sourceLink = document.getElementById('inp-source-link').value;
    
    renderPreview();
    generateCode();
  }

  /* --- MÓDULO DE IMPORTAÇÃO (NOVO) --- */
  function openImportModal() {
      document.getElementById('import-modal').style.display = 'flex';
      document.getElementById('import-area').value = '';
      document.getElementById('import-area').focus();
  }

  function processImport() {
      const htmlCode = document.getElementById('import-area').value;
      if (!htmlCode.trim()) return;

      try {
          // Parse do HTML
          const parser = new DOMParser();
          const doc = parser.parseFromString(htmlCode, 'text/html');

          // 1. Infos Básicas
          const detailsList = doc.querySelectorAll('.log-details li');
          if(detailsList.length > 0) {
              const charAnchor = detailsList[0].querySelector('a');
              if(charAnchor) {
                  state.char = charAnchor.textContent;
                  state.charLink = charAnchor.getAttribute('href');
              }
              
              const dateSpan = detailsList[1].querySelector('.value');
              if(dateSpan) state.date = dateSpan.textContent;

              const sourceAnchor = detailsList[2].querySelector('a');
              if(sourceAnchor) {
                  state.source = sourceAnchor.textContent;
                  state.sourceLink = sourceAnchor.getAttribute('href');
              }
          }

          // 2. Links Extras
          state.links = [];
          doc.querySelectorAll('.log-details li').forEach(li => {
              const label = li.querySelector('.label');
              if(label && label.textContent.includes('Extra')) {
                  const link = li.querySelector('a');
                  if(link) {
                      state.links.push({ title: link.textContent, url: link.getAttribute('href') });
                  }
              }
          });

          // 3. Stats Grid
          state.stats = [];
          const listDe = doc.querySelectorAll('.log-box.before li');
          const listPara = doc.querySelectorAll('.log-box.after li');

          listDe.forEach((itemDe, index) => {
              // Formato esperado: "Nome: Valor"
              const textDe = itemDe.textContent;
              const splitDe = textDe.split(':');
              const name = splitDe[0].trim();
              const oldVal = splitDe.slice(1).join(':').trim(); // Caso o valor tenha :, junta de volta

              let newVal = "";
              if(listPara[index]) {
                  const textPara = listPara[index].textContent;
                  const splitPara = textPara.split(':');
                  newVal = splitPara.slice(1).join(':').trim();
              }

              state.stats.push({ name, oldVal, newVal });
          });

          // 4. Blocos
          state.blocks = [];
          doc.querySelectorAll('.log-text-block').forEach(block => {
              const titleEl = block.querySelector('.log-text-title');
              // Remove as tags de status do título
              let rawTitle = titleEl.textContent;
              rawTitle = rawTitle.replace('[+ ADICIONADO]', '').replace('[- REMOVIDO]', '').trim();

              const contentDiv = block.querySelector('.log-text-content');
              
              if(block.classList.contains('add')) {
                  // Bloco de Adição (Parágrafo)
                  const p = contentDiv.querySelector('p');
                  // Converte <br> de volta para quebra de linha
                  let content = p ? p.innerHTML.replace(/<br\s*\/?>/gi, '\n') : "";
                  // Remove tags HTML se houver sobra
                  content = content.replace(/<[^>]*>?/gm, ''); 
                  
                  state.blocks.push({ type: 'add', title: rawTitle, content: content });
              } else {
                  // Bloco de Remoção (Lista)
                  const lis = contentDiv.querySelectorAll('li');
                  let items = [];
                  lis.forEach(li => items.push(li.textContent));
                  state.blocks.push({ type: 'remove', title: rawTitle, content: items.join('\n') });
              }
          });

          // Finalizar Importação
          document.getElementById('inp-char').value = state.char;
          document.getElementById('inp-char-link').value = state.charLink;
          document.getElementById('inp-date').value = state.date;
          document.getElementById('inp-source').value = state.source;
          document.getElementById('inp-source-link').value = state.sourceLink;

          renderLinksInputs();
          renderStatsInputs();
          renderBlocksInputs();
          upd();
          
          closeModal('import-modal');
          showToast("Log Importado com Sucesso!");

      } catch (e) {
          console.error(e);
          alert("Erro ao ler o código. Certifique-se de colar o HTML completo.");
      }
  }

  /* --- LÓGICA DE UI --- */

  function addLink(render = true) {
    state.links.push({ title: "", url: "" });
    if(render) { renderLinksInputs(); upd(); }
  }
  function removeLink(index) {
    state.links.splice(index, 1);
    renderLinksInputs();
    upd();
  }
  function updateLink(index, field, value) {
    state.links[index][field] = value;
    upd();
  }
  function renderLinksInputs() {
    const container = document.getElementById('links-list');
    container.innerHTML = '';
    state.links.forEach((link, idx) => {
        const div = document.createElement('div');
        div.className = 'dynamic-item';
        div.innerHTML = `
            <span class="btn-remove" onclick="removeLink(${idx})">✕</span>
            <input type="text" placeholder="Descrição (ex: Compra Loja)" value="${link.title}" oninput="updateLink(${idx}, 'title', this.value)" style="margin-bottom:5px;">
            <input type="text" placeholder="URL do Tópico" value="${link.url}" oninput="updateLink(${idx}, 'url', this.value)">
        `;
        container.appendChild(div);
    });
  }

  function addStat(render = true) {
    state.stats.push({ name: "", oldVal: "", newVal: "" });
    if(render) { renderStatsInputs(); upd(); }
  }
  function removeStat(index) {
    state.stats.splice(index, 1);
    renderStatsInputs();
    upd();
  }
  function updateStat(index, field, value) {
    state.stats[index][field] = value;
    upd();
  }
  function renderStatsInputs() {
    const container = document.getElementById('stats-list');
    container.innerHTML = '';
    state.stats.forEach((stat, idx) => {
        const div = document.createElement('div');
        div.className = 'dynamic-item';
        div.innerHTML = `
            <span class="btn-remove" onclick="removeStat(${idx})">✕</span>
            <div class="stat-row">
                <input type="text" placeholder="Atributo/Aptidão" value="${stat.name}" oninput="updateStat(${idx}, 'name', this.value)">
                <input type="text" placeholder="DE" value="${stat.oldVal}" oninput="updateStat(${idx}, 'oldVal', this.value)" style="text-align:center;">
                <input type="text" placeholder="PARA" value="${stat.newVal}" oninput="updateStat(${idx}, 'newVal', this.value)" style="text-align:center;">
            </div>
        `;
        container.appendChild(div);
    });
  }

  function addBlock(type) {
    state.blocks.push({ type: type, title: "", content: "" });
    renderBlocksInputs();
    upd();
  }
  function removeBlock(index) {
    state.blocks.splice(index, 1);
    renderBlocksInputs();
    upd();
  }
  function updateBlock(index, field, value) {
    state.blocks[index][field] = value;
    upd();
  }
  function renderBlocksInputs() {
    const container = document.getElementById('blocks-list');
    container.innerHTML = '';
    state.blocks.forEach((block, idx) => {
        const div = document.createElement('div');
        div.className = 'dynamic-item';
        div.style.borderLeft = block.type === 'add' ? '3px solid #20c56d' : '3px solid #c52020';
        
        const typeLabel = block.type === 'add' ? 'ADICIONADO (+)' : 'REMOVIDO (-)';
        const phContent = block.type === 'add' ? 'Texto descritivo...' : 'Itens removidos (um por linha)...';
        
        div.innerHTML = `
            <span class="btn-remove" onclick="removeBlock(${idx})">✕</span>
            <label style="color:${block.type === 'add' ? '#20c56d' : '#c52020'}">${typeLabel}</label>
            <input type="text" placeholder="Título da Seção (Ex: Técnicas)" value="${block.title}" oninput="updateBlock(${idx}, 'title', this.value)" style="margin-bottom:5px;">
            <textarea placeholder="${phContent}" rows="3" oninput="updateBlock(${idx}, 'content', this.value)">${block.content}</textarea>
        `;
        container.appendChild(div);
    });
  }

  function renderPreview() {
    const p = document.getElementById('preview-box');
    
    let listDe = '';
    let listPara = '';
    let hasStats = false;

    state.stats.forEach(s => {
        if(s.name) {
            listDe += `<li>${s.name}: ${s.oldVal}</li>`;
            listPara += `<li>${s.name}: ${s.newVal}</li>`;
            hasStats = true;
        }
    });

    let gridHTML = '';
    if (hasStats) {
        gridHTML = `
        <div class="log-changes-grid">
            <div class="log-box before">
                <div class="log-box-title">DE</div>
                <ul>${listDe}</ul>
            </div>
            <div class="log-box after">
                <div class="log-box-title">PARA</div>
                <ul>${listPara}</ul>
            </div>
        </div>`;
    }
    
    let extraLinksHTML = '';
    state.links.forEach(l => {
        if(l.title && l.url) {
            extraLinksHTML += `<li><span class="label">Extra:</span><span class="value"><a href="${l.url}" target="_blank">${l.title}</a></span></li>`;
        }
    });

    let blocksHTML = '';
    state.blocks.forEach(b => {
        if(b.type === 'add') {
            blocksHTML += `
            <div class="log-text-block add">
                <div class="log-text-title">${b.title} <span class="log-status-tag">[+ ADICIONADO]</span></div>
                <div class="log-text-content"><p>${b.content.replace(/\n/g, '<br>')}</p></div>
            </div>`;
        } else {
            const items = b.content.split('\n').filter(l => l.trim() !== '').map(l => `<li style="padding-left: 0; margin-bottom: 8px;">${l}</li>`).join('');
            blocksHTML += `
            <div class="log-text-block remove">
                <div class="log-text-title">${b.title} <span class="log-status-tag">[- REMOVIDO]</span></div>
                <div class="log-text-content">
                    <ul style="list-style: none; padding: 0; margin: 0;">${items}</ul>
                </div>
            </div>`;
        }
    });

    const html = `
      <div class="log-container">
        <div class="log-header">
            <div class="log-icon">記</div>
            <h2 class="log-title">Registro de Modificação</h2>
        </div>
        <div class="log-body">
            <ul class="log-details">
                <li><span class="label">Personagem:</span><span class="value"><a href="${state.charLink}" target="_blank">${state.char}</a></span></li>
                <li><span class="label">Data da Mudança:</span><span class="value">${state.date}</span></li>
                <li><span class="label">Fonte da Mudança:</span><span class="value"><a href="${state.sourceLink}" target="_blank">${state.source}</a></span></li>
                ${extraLinksHTML}
            </ul>
            ${gridHTML}
            ${blocksHTML}
        </div>
      </div>
    `;
    
    p.innerHTML = html;
  }

  function generateCode() {
    const container = document.getElementById('preview-box');
    const coreHTML = container.innerHTML;
    const fullHTML = `<link href="https://gaaaaaaaaabs.github.io/goldenagerepositor.io/log-ficha.css" rel="stylesheet" type="text/css">${coreHTML}`;
    const minified = fullHTML.replace(/(\r\n|\n|\r)/gm, "").replace(/\s+/g, ' ').replace(/> </g, '><');
    document.getElementById('output-code').value = minified;
  }

  function copyCode() {
    document.getElementById('output-code').select();
    document.execCommand('copy');
    showToast("Código Copiado com Sucesso!");
  }

  // --- FUNÇÕES DE CONTROLE DE MODAL/TOAST ---
  function showToast(msg) {
      const t = document.getElementById('toast');
      t.innerText = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
  }

  function closeModal(id) {
      document.getElementById(id).style.display = 'none';
  }

  function confirmReset() {
      const modal = document.getElementById('confirm-modal');
      const msg = document.getElementById('confirm-msg');
      const btnYes = document.getElementById('confirm-yes-btn');
      
      msg.innerText = "Isso apagará todos os dados atuais. Deseja continuar?";
      modal.style.display = 'flex';
      
      btnYes.onclick = function() {
          resetData();
          closeModal('confirm-modal');
      }
  }

  function resetData() {
       document.getElementById('inp-char').value = "";
       document.getElementById('inp-char-link').value = "";
       document.getElementById('inp-source').value = "";
       document.getElementById('inp-source-link').value = "";
       state.stats = [];
       state.links = [];
       state.blocks = [];
       addStat();
       renderStatsInputs();
       renderLinksInputs();
       renderBlocksInputs();
       upd();
  }

  // Init
  document.getElementById('inp-date').value = state.date;
  renderStatsInputs();
</script>
</body>
</html>
